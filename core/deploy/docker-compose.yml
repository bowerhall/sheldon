# Sheldon Standard Setup
#
# Usage:
#   1. Set secrets in Doppler (or copy .env.example to .env)
#   2. docker compose up -d
#   3. Message your Telegram bot

services:
  traefik:
    image: traefik:v2.11
    container_name: traefik
    restart: unless-stopped
    command:
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=sheldon-net"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # Let's Encrypt HTTPS (requires ACME_EMAIL and DOMAIN in .env)
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
    network_mode: host
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./letsencrypt:/letsencrypt
      - ./traefik:/etc/traefik/dynamic:ro
    labels:
      # Disable self-discovery (use file provider for dashboard instead)
      - "traefik.enable=false"

  # Docker socket proxy - limits what Sheldon can do with docker
  docker-proxy:
    image: tecnativa/docker-socket-proxy
    container_name: docker-proxy
    restart: unless-stopped
    environment:
      - CONTAINERS=1      # list, create, start, stop containers
      - IMAGES=1          # pull images
      - BUILD=1           # build images (required for docker compose build)
      - NETWORKS=1        # connect to networks
      - POST=1            # allow POST requests (create containers)
      - VOLUMES=0         # no volume management API
      - SERVICES=0        # no swarm services
      - TASKS=0           # no swarm tasks
      - SECRETS=0         # no secrets API
      - CONFIGS=0         # no configs API
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - sheldon-net

  sheldon:
    image: ${SHELDON_IMAGE:-ghcr.io/bowerhall/sheldon:latest}
    container_name: sheldon
    restart: unless-stopped
    depends_on:
      - ollama
      - minio-init
      - docker-proxy
    volumes:
      - ./data:/data
      - ./skills:/data/skills
      - ./essence:/app/essence:ro
    environment:
      # Docker via proxy (limited access)
      - DOCKER_HOST=tcp://docker-proxy:2375
      - DOCKER_API_VERSION=1.44
      - DOCKER_BUILDKIT=0  # proxy doesn't support BuildKit gRPC

      # Required
      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
      - OWNER_CHAT_ID=${OWNER_CHAT_ID:-}
      - KIMI_API_KEY=${KIMI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - LLM_PROVIDER=${LLM_PROVIDER:-kimi}
      - LLM_MODEL=${LLM_MODEL:-kimi-k2-0711-preview}
      - DOMAIN=${DOMAIN}

      # Paths (fixed for container)
      - SHELDON_MEMORY=/data/sheldon.db
      - SHELDON_ESSENCE=/app/essence
      - CODER_SANDBOX=/data/sandbox
      - CODER_HOST_SANDBOX=/opt/sheldon/data/sandbox
      # Deployer paths (container â†’ host translation for docker compose)
      - DEPLOYER_APPS_FILE=/data/apps.yml
      - DEPLOYER_HOST_APPS_FILE=/opt/sheldon/data/apps.yml
      - DEPLOYER_PATH_PREFIX=/data
      - DEPLOYER_HOST_PREFIX=/opt/sheldon/data

      # Embeddings (Ollama runs alongside)
      - OLLAMA_HOST=${OLLAMA_HOST:-http://ollama:11434}
      - EMBEDDER_PROVIDER=ollama
      - EMBEDDER_URL=http://ollama:11434
      - EMBEDDER_MODEL=nomic-embed-text

      # Extractor (local model via Ollama - no API cost)
      - EXTRACTOR_PROVIDER=ollama
      - EXTRACTOR_BASE_URL=http://ollama:11434
      - EXTRACTOR_MODEL=qwen2.5:3b

      # Coder (uses same provider keys as LLM - KIMI_API_KEY, ANTHROPIC_API_KEY, etc.)
      # Set CODER_PROVIDER and CODER_MODEL to override (default: kimi, kimi-k2.5:cloud)

      # Storage (MinIO) - Sheldon uses limited 'sheldon' user, not admin
      - STORAGE_ENABLED=true
      - STORAGE_ENDPOINT=minio:9000
      - STORAGE_ACCESS_KEY=sheldon
      - STORAGE_SHELDON_PASSWORD=${STORAGE_SHELDON_PASSWORD}
      - STORAGE_USE_SSL=false

      # Git integration (optional)
      - GIT_TOKEN=${GIT_TOKEN:-}
      - GIT_USER_NAME=${GIT_USER_NAME:-Sheldon}
      - GIT_USER_EMAIL=${GIT_USER_EMAIL:-}
      - GIT_ORG_URL=${GIT_ORG_URL:-}

      # Alert chat ID (optional) - for budget warnings and error alerts
      - HEARTBEAT_CHAT_ID=${HEARTBEAT_CHAT_ID:-}

      # Budget (daily token limit, default 10M)
      - BUDGET_DAILY_LIMIT=${BUDGET_DAILY_LIMIT:-10000000}

      # Conversation buffer (recent messages in context, default 12)
      - CONVERSATION_BUFFER_SIZE=${CONVERSATION_BUFFER_SIZE:-12}

      # Timezone
      - TZ=${TZ:-UTC}
    networks:
      - sheldon-net

  ollama:
    image: ollama/ollama
    container_name: ollama
    restart: unless-stopped
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - sheldon-net
    # Pull models on first start (embeddings + extraction)
    entrypoint: ["/bin/sh", "-c", "ollama serve & sleep 5 && ollama pull nomic-embed-text && ollama pull qwen2.5:3b && wait"]

  minio:
    image: minio/minio:latest
    container_name: minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    environment:
      # Admin credentials (for human access via console)
      - MINIO_ROOT_USER=admin
      - MINIO_ROOT_PASSWORD=${STORAGE_ADMIN_PASSWORD}
    networks:
      - sheldon-net
    labels:
      - "traefik.enable=true"
      # MinIO Console (web UI)
      - "traefik.http.routers.minio-console.rule=Host(`storage.${DOMAIN}`)"
      - "traefik.http.routers.minio-console.entrypoints=websecure"
      - "traefik.http.routers.minio-console.tls.certresolver=letsencrypt"
      - "traefik.http.routers.minio-console.service=minio-console"
      - "traefik.http.services.minio-console.loadbalancer.server.port=9001"

  # Creates 'sheldon' user with access only to sheldon-* buckets
  minio-init:
    image: minio/mc:latest
    container_name: minio-init
    depends_on:
      - minio
    environment:
      - STORAGE_ADMIN_PASSWORD=${STORAGE_ADMIN_PASSWORD}
      - STORAGE_SHELDON_PASSWORD=${STORAGE_SHELDON_PASSWORD}
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        sleep 5
        mc alias set minio http://minio:9000 admin $${STORAGE_ADMIN_PASSWORD}

        # Create buckets
        mc mb --ignore-existing minio/sheldon-user
        mc mb --ignore-existing minio/sheldon-agent
        mc mb --ignore-existing minio/sheldon-backups
        mc mb --ignore-existing minio/private

        # Create policy for sheldon user (only sheldon-* buckets)
        cat > /tmp/sheldon-policy.json << 'EOF'
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Action": ["s3:*"],
              "Resource": [
                "arn:aws:s3:::sheldon-user",
                "arn:aws:s3:::sheldon-user/*",
                "arn:aws:s3:::sheldon-agent",
                "arn:aws:s3:::sheldon-agent/*",
                "arn:aws:s3:::sheldon-backups",
                "arn:aws:s3:::sheldon-backups/*"
              ]
            }
          ]
        }
        EOF

        mc admin policy create minio sheldon-policy /tmp/sheldon-policy.json 2>/dev/null || mc admin policy info minio sheldon-policy

        # Create sheldon user if not exists
        mc admin user add minio sheldon $${STORAGE_SHELDON_PASSWORD} 2>/dev/null || true
        mc admin policy attach minio sheldon-policy --user sheldon

        echo "MinIO init complete: sheldon user created with limited access"
    networks:
      - sheldon-net

  # Headscale - self-hosted Tailscale coordination server
  headscale:
    image: headscale/headscale:latest
    container_name: headscale
    restart: unless-stopped
    depends_on:
      headscale-init:
        condition: service_completed_successfully
    volumes:
      - ./headscale:/etc/headscale
      - headscale_data:/var/lib/headscale
    command: serve
    networks:
      - sheldon-net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.headscale.rule=Host(`hs.${DOMAIN}`)"
      - "traefik.http.routers.headscale.entrypoints=websecure"
      - "traefik.http.routers.headscale.tls.certresolver=letsencrypt"
      - "traefik.http.services.headscale.loadbalancer.server.port=8080"

  # Initializes headscale config with correct domain
  headscale-init:
    image: alpine:latest
    container_name: headscale-init
    volumes:
      - ./headscale:/etc/headscale
    environment:
      - DOMAIN=${DOMAIN}
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        # Replace domain placeholder in config if needed
        if grep -q "DOMAIN_PLACEHOLDER" /etc/headscale/config.yaml 2>/dev/null; then
          sed -i "s/DOMAIN_PLACEHOLDER/$${DOMAIN}/g" /etc/headscale/config.yaml
          echo "Headscale config: domain set to $${DOMAIN}"
        else
          echo "Headscale config: already configured"
        fi

networks:
  sheldon-net:
    name: sheldon-net
    driver: bridge

volumes:
  ollama_data:
  minio_data:
  headscale_data:
