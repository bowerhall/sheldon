# Security Architecture

## Threat Model

### Attack Surface

- **Telegram bot token**: Only external credential. If compromised, attacker can send messages to bot.
- **No inbound ports**: Telegram uses long-polling (outbound only).
- **Skills**: User-installed markdown files that instruct the agent. Potential vector for prompt injection.
- **Deployed apps**: Code generated by Coder runs in Docker containers on same network.

## Three-Layer Defense

### Layer 1: Container Isolation

**Ephemeral Coder Containers:**
Coder runs in isolated Docker containers (`docker run --rm`), not inside Sheldon:

```
┌─────────────┐  docker run --rm  ┌──────────────────┐
│   SHELDON   │──────────────────▶│ Ephemeral Coder  │
│             │                   │ ┌──────────────┐ │
│             │                   │ │ Coder sandbox│ │
│             │◀──────────────────│ │ (own API key)│ │
│             │   artifacts       │ └──────────────┘ │
└─────────────┘                   └──────────────────┘
                                         │
                                    auto-delete (--rm)
```

Benefits:

- Coder cannot access Sheldon's filesystem, sheldon.db, or secrets
- Separate API key (NVIDIA/Kimi) - rotatable without affecting Sheldon
- Container deleted after task - no persistent compromise
- Clean environment every task

**Browser Sandbox:**

- Runs agent-browser in isolated Docker container
- Command whitelist (only `open`, `click`, `fill`, etc.)
- Shell metacharacter rejection
- Non-root user, no host filesystem access
- Container deleted after each session

**Deployed Apps:**

- Non-root containers (recommended in compose)
- No access to host filesystem (except explicit volume mounts)
- Resource limits via Docker

### Layer 2: Network Security

**Docker network isolation:**

- All services on `sheldon-net` network
- Traefik handles external routing
- No direct port exposure for Sheldon or apps

**Outbound only:**

- Telegram: long-polling (no inbound ports needed)
- LLM APIs: HTTPS outbound
- No listening services exposed to internet (except Traefik 80/443)

### Layer 3: Application Security

**Output Sanitization:**

```go
var sensitivePatterns = []*regexp.Regexp{
    regexp.MustCompile(`sk-ant-[a-zA-Z0-9\-_]{20,}`),    // Anthropic keys
    regexp.MustCompile(`bot\d+:[a-zA-Z0-9_-]{35}`),       // Telegram tokens
    regexp.MustCompile(`AKIA[0-9A-Z]{16}`),               // AWS keys
    regexp.MustCompile(`ghp_[a-zA-Z0-9]{36}`),            // GitHub PATs
}
```

**Skill Security:**

- Skills are markdown files that instruct the agent
- Malicious skills could instruct data exfiltration
- Mitigations:
  - Content preview before install (TODO)
  - Coder isolation prevents direct access to sheldon.db
  - Audit logging for skill activations (TODO)

## sheldonmem Security

- SQLite file permissions: 0600, owned by sheldon user
- WAL mode: concurrent reads, single writer
- No network exposure: sheldonmem is in-process
- Backup: SQLite snapshot to MinIO (TODO: encryption)
- No PII in logs: facts logged with domain ID only

## Docker Access Control

Sheldon connects to Docker through `tecnativa/docker-socket-proxy`, which limits API access:

```yaml
docker-proxy:
  environment:
    - CONTAINERS=1      # list, create, start, stop
    - IMAGES=1          # pull images
    - BUILD=1           # build images
    - NETWORKS=1        # connect to networks
    - POST=1            # allow create operations
    - VOLUMES=0         # NO volume management
    - SERVICES=0        # NO swarm services
    - SECRETS=0         # NO secrets API
    - CONFIGS=0         # NO configs API
```

Sheldon can only manage containers/images scoped to `apps.yml` - cannot access secrets, volumes API, or swarm.

## Runtime Config Security

Sheldon can change some config at runtime via `set_config`, but critical infrastructure is locked:

| Config | Runtime Changeable | Reason |
|--------|-------------------|--------|
| `llm_provider/model` | Yes | User-facing, safe to switch |
| `coder_provider/model` | Yes | User-facing, safe to switch |
| `embedder_*` | **No** | Changing breaks vector compatibility |
| `extractor_*` | **No** | Infrastructure, not user-facing |
| `ollama_host` | **No** | Prevents rogue server attacks |

An attacker cannot trick Sheldon into pointing to a malicious ollama server or breaking embeddings.

## Model Management Security

Sheldon can pull and remove ollama models, with protections:

- **Cannot remove active embedder model** (e.g., `nomic-embed-text`)
- **Cannot remove active extractor model** (e.g., `qwen2.5:3b`)
- **Requires explicit confirmation** before pull/remove

This prevents an attacker from tricking Sheldon into breaking memory search or extraction.

## Credential Management

| Credential        | Storage   | Exposed To           |
| ----------------- | --------- | -------------------- |
| TELEGRAM_TOKEN    | Doppler   | Sheldon only         |
| ANTHROPIC_API_KEY | Doppler   | Sheldon only         |
| KIMI_API_KEY      | Doppler   | Sheldon + Coder      |
| MINIO_CREDENTIALS | Doppler   | Sheldon only         |
| GIT_TOKEN         | Doppler   | Sheldon only (NOT Coder) |

Coder does NOT receive GIT_TOKEN - Sheldon handles all git operations externally. If coder is compromised, it cannot push to repos.

## GitHub Access Control

Sheldon has write access to a dedicated GitHub org via `GIT_TOKEN`:

```
┌─────────────────────────────────────────────────────────────┐
│                    GitHub Org (bowerhall)                   │
│                                                             │
│  ┌──────────────────┐  ┌──────────────────┐                 │
│  │ sheldon (repo)   │  │ weather-bot      │                 │
│  │                  │  │ (generated)      │                 │
│  │ main: PROTECTED  │  │                  │                 │
│  │ - requires PR    │  │ main: unprotected│                 │
│  │ - user reviews   │  │ (new project)    │                 │
│  └──────────────────┘  └──────────────────┘                 │
│                                                             │
│  Sheldon can:                                               │
│  ✓ Create new repos                                         │
│  ✓ Push branches                                            │
│  ✓ Open PRs                                                 │
│  ✗ Push to protected main                                   │
│  ✗ Access repos outside org                                 │
└─────────────────────────────────────────────────────────────┘
```

**Self-improvement flow**:

1. Sheldon creates branch `feature/xyz` on `bowerhall/sheldon`
2. Pushes code changes
3. Opens PR via GitHub API
4. User reviews, approves, merges
5. CI/CD deploys new version

**New project flow**:

1. Sheldon creates `bowerhall/new-project`
2. Pushes generated code to main (no protection yet)
3. User can add branch protection rules later if needed

**PAT scope**: Token should be scoped to the org only, with `repo` permission. Never use a token with access to personal repos.

## Network Diagram

```
                         INTERNET
                             │
           ┌─────────────────┼─────────────────┐
           │                 │                 │
           ▼                 ▼                 ▼
      Telegram API      LLM APIs          Kimi/NVIDIA
           ▲                 ▲                 ▲
           │                 │                 │
           │   OUTBOUND ONLY │                 │
           │   (no listeners)│                 │
    ═══════╪═════════════════╪═════════════════╪═══════
           │     Docker Compose                │
           │                                   │
     ┌─────┴─────┐                    ┌────────┴───────┐
     │  SHELDON  │───────────────────▶│ Ephemeral      │
     │           │  docker run --rm   │ Coder Container│
     │           │◀───────────────────│                │
     │           │     artifacts      └────────────────┘
     │           │
     │           │───────────────────▶┌────────────────┐
     │           │  docker run --rm   │ Browser        │
     │           │◀───────────────────│ Sandbox        │
     │           │     page content   └────────────────┘
     └─────┬─────┘
           │
     ┌─────┴─────┐
     │           │
     ▼           ▼
┌─────────┐ ┌─────────┐
│ Traefik  │ │  MinIO  │
│   :80   │ │  :9000  │
└─────────┘ └─────────┘
     │
     │ ROUTES TO
     ▼
┌───────────┐
│ Deployed  │──────▶ INTERNET
│   Apps    │
└───────────┘
```

## Incident Response

**If NVIDIA/Kimi API key compromised:**

1. Rotate key in provider console
2. Update .env file
3. Restart Sheldon (`docker compose restart`)
4. Review recent Coder outputs for exfiltration

**If Telegram token compromised:**

1. Revoke via BotFather
2. Create new token
3. Update .env file
4. Restart Sheldon

**If malicious skill installed:**

1. `remove_skill` to delete
2. Review recent conversation history
3. Check for deployed apps from that period
4. Remove suspicious apps via `remove_app`
