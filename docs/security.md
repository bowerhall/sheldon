# Security Architecture

## Threat Model

### Attack Surface
- **Telegram bot token**: Only external credential. If compromised, attacker can send messages to bot.
- **No inbound ports**: Telegram uses long-polling (outbound only).
- **Skills**: User-installed markdown files that instruct the agent. Potential vector for prompt injection.
- **Deployed apps**: Code generated by Claude Code runs in kora-apps namespace.

### Trust Boundaries
```
┌─────────────────────────────────────────────────────────┐
│                    TRUSTED (kora namespace)             │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐    │
│  │  Kora   │  │ Ollama  │  │  MinIO  │  │ Backups │    │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘    │
└─────────────────────────────────────────────────────────┘
        │                                    ▲
        │ CAN CALL                           │ BLOCKED
        ▼                                    │
┌─────────────────────────────────────────────────────────┐
│                 UNTRUSTED (kora-apps namespace)         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ Deployed    │  │ Deployed    │  │ Deployed    │     │
│  │ App A       │  │ App B       │  │ App C       │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
        │
        │ CAN CALL
        ▼
    INTERNET (external APIs only)
```

## Four-Layer Defense

### Layer 1: Kubernetes RBAC
- **kora ServiceAccount**: Can create/update/delete in kora-apps namespace
- **Cannot**: exec into pods, modify RBAC, access other namespaces
- **Deployer permissions**: Scoped to Deployments, Services, ConfigMaps, Secrets, Pods (CRUD)

### Layer 2: Network Policies

**kora namespace:**
- Default deny all
- Kora: egress to Telegram API, LLM APIs, k8s API, internal services (Ollama, MinIO)
- Ollama: ingress from Kora only, no external access
- MinIO: ingress from kora namespace only

**kora-apps namespace:**
- Default deny all
- Ingress: allowed from kora namespace only (Kora can call deployed apps)
- Egress: allowed to internet (80, 443) for external APIs
- Egress: BLOCKED to kora namespace (apps cannot call back to Kora)

### Layer 3: Container Isolation

**Ephemeral Claude Code Containers:**
Claude Code runs in isolated k8s Jobs, not inside Kora pod:

```
┌─────────────┐     spawn Job    ┌──────────────────┐
│    KORA     │─────────────────▶│ Ephemeral Job    │
│             │                  │ ┌──────────────┐ │
│             │                  │ │ Claude Code  │ │
│             │◀─────────────────│ │ (own API key)│ │
│             │   artifacts      │ └──────────────┘ │
└─────────────┘                  └──────────────────┘
                                        │
                                   auto-delete
```

Benefits:
- Claude Code cannot access Kora's filesystem, kora.db, or secrets
- Separate API key (CODER_API_KEY) - rotatable without affecting Kora
- Container deleted after task - no persistent compromise
- Clean environment every task

**Deployed Apps (kora-apps):**
- PodSecurity: restricted profile (non-root, no privilege escalation)
- ResourceQuota: max 10 pods, 4 CPU, 4Gi memory
- No access to host filesystem

### Layer 4: Application Security

**Output Sanitization:**
```go
var sensitivePatterns = []*regexp.Regexp{
    regexp.MustCompile(`sk-ant-[a-zA-Z0-9\-_]{20,}`),    // Anthropic keys
    regexp.MustCompile(`bot\d+:[a-zA-Z0-9_-]{35}`),       // Telegram tokens
    regexp.MustCompile(`AKIA[0-9A-Z]{16}`),               // AWS keys
    regexp.MustCompile(`ghp_[a-zA-Z0-9]{36}`),            // GitHub PATs
}
```

**Skill Security:**
- Skills are markdown files that instruct the agent
- Malicious skills could instruct data exfiltration
- Mitigations:
  - Content preview before install (TODO)
  - Claude Code isolation prevents direct access to kora.db
  - Audit logging for skill activations (TODO)

## koramem Security

- SQLite file permissions: 0600, owned by kora user
- WAL mode: concurrent reads, single writer
- No network exposure: koramem is in-process
- Backup encryption: SQLite snapshot to MinIO (TODO: encryption)
- Fact deletion: `/review` command allows deletion (TODO)
- No PII in logs: facts logged with domain ID only

## Credential Management

| Credential | Storage | Exposed To |
|------------|---------|------------|
| TELEGRAM_TOKEN | k8s Secret | Kora only |
| LLM_API_KEY | k8s Secret | Kora only |
| CODER_API_KEY | k8s Secret | Ephemeral Claude Code Jobs only |
| MINIO_CREDENTIALS | k8s Secret | Kora, backup jobs |
| ANTHROPIC_API_KEY (Kora's) | k8s Secret | Kora only, NOT Claude Code |

Claude Code gets its own dedicated API key, not Kora's main key. If compromised via malicious code, only that key needs rotation.

## Network Diagram

```
                         INTERNET
                             │
           ┌─────────────────┼─────────────────┐
           │                 │                 │
           ▼                 ▼                 ▼
      Telegram API      LLM APIs          Claude API
           ▲                 ▲                 ▲
           │                 │                 │
           │   OUTBOUND ONLY │                 │
           │   (no listeners)│                 │
    ═══════╪═════════════════╪═════════════════╪═══════
           │        k8s cluster                │
           │                                   │
     ┌─────┴─────┐                    ┌────────┴───────┐
     │   KORA    │───────────────────▶│ Ephemeral Job  │
     │           │     spawn          │ (Claude Code)  │
     │           │◀───────────────────│                │
     │           │     artifacts      └────────────────┘
     └─────┬─────┘
           │
     ┌─────┴─────┐
     │           │
     ▼           ▼
┌─────────┐ ┌─────────┐
│ Ollama  │ │  MinIO  │
│ :11434  │ │  :9000  │
└─────────┘ └─────────┘

           │
           │ CAN CALL
           ▼
     ┌───────────┐
     │ kora-apps │──────▶ INTERNET
     │ namespace │
     └───────────┘
           │
           ✕ BLOCKED to kora namespace
```

## Incident Response

**If CODER_API_KEY compromised:**
1. Rotate key in Anthropic console
2. Update k8s secret
3. Restart Kora deployment
4. Review recent Claude Code outputs for exfiltration

**If Telegram token compromised:**
1. Revoke via BotFather
2. Create new token
3. Update k8s secret
4. Restart Kora

**If malicious skill installed:**
1. `remove_skill` to delete
2. Review recent conversation history
3. Check for deployed apps from that period
4. Delete suspicious deployments in kora-apps
